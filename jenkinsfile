pipeline {
    agent any

    stages {
        stage('Docker Build') {
            steps {
                sh '''
                # Docker Build
                sudo docker build -t 642958529262.dkr.ecr.ap-southeast-2.amazonaws.com/static-apache:$BUILD_NUMBER .
                # ecr Login
                sudo aws ecr get-login-password --region ap-southeast-2 | sudo docker login --username AWS --password-stdin 642958529262.dkr.ecr.ap-southeast-2.amazonaws.com
                # push the image to ecr
                sudo docker push 6642958529262.dkr.ecr.ap-southeast-2.amazonaws.com/static-apache:$BUILD_NUMBER '''
            }
        }
        stage('EKS Deploy') {
            steps {
                sh '''
                # apply kubectl
                cd k8s/
                kubectl apply -f namespace.yaml deployment.yaml service.yaml ingress.yaml '''
            }
        }
        stage('Validation') {
            steps {
                sh '''
                cd k8s/
                # apply kubectl
                kubectl get po -A '''
            }
        }
    }
}